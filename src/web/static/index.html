<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Starrain-BOT ç®¡ç†åå°</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-tertiary:#334155;
--border-color:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;
--accent:#6366f1;--accent-hover:#818cf8;--success:#22c55e;
--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6
}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 100%)}
.login-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:48px;width:100%;max-width:400px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
.login-title{font-size:28px;font-weight:700;text-align:center;margin-bottom:8px;background:linear-gradient(135deg,#6366f1,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-subtitle{text-align:center;color:var(--text-secondary);margin-bottom:32px}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:14px;font-weight:500;color:var(--text-secondary);margin-bottom:8px}
.form-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:16px;font-family:inherit;transition:all .2s}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(99,102,241,.2)}
.btn{padding:12px 24px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;border:none}
.btn-primary{background:var(--accent);color:white;width:100%}
.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px)}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-secondary:hover{background:var(--border-color)}
.btn-success{background:var(--success);color:white}
.btn-danger{background:var(--danger);color:white}
.btn-warning{background:var(--warning);color:white}
.btn-sm{padding:8px 16px;font-size:13px}
.app-container{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--bg-secondary);border-right:1px solid var(--border-color);display:flex;flex-direction:column;position:fixed;height:100vh;overflow-y:auto}
.sidebar-header{padding:24px;border-bottom:1px solid var(--border-color)}
.sidebar-brand{font-size:22px;font-weight:700;background:linear-gradient(135deg,#6366f1,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-status{display:flex;align-items:center;gap:8px;margin-top:12px;font-size:13px;color:var(--text-secondary)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--success);animation:pulse 2s infinite}
.status-dot.disconnected{background:var(--danger);animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.sidebar-nav{padding:16px 12px;flex:1}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;color:var(--text-secondary);cursor:pointer;transition:all .2s;margin-bottom:4px}
.nav-item:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.nav-item.active{background:var(--accent);color:white}
.main-content{flex:1;margin-left:260px;padding:32px;background:var(--bg-primary)}
.page-header{margin-bottom:32px}
.page-title{font-size:28px;font-weight:700;margin-bottom:8px}
.page-desc{color:var(--text-secondary)}
.card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-bottom:24px}
.card-title{font-size:18px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:24px}
.stat-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px}
.stat-label{color:var(--text-secondary);font-size:14px;margin-bottom:8px}
.stat-value{font-size:28px;font-weight:700}
.stat-value.success{color:var(--success)}
.stat-value.warning{color:var(--warning)}
.stat-value.danger{color:var(--danger)}
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:14px 16px;text-align:left;border-bottom:1px solid var(--border-color)}
th{color:var(--text-secondary);font-weight:600;font-size:13px;text-transform:uppercase}
tr:hover{background:var(--bg-tertiary)}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
.badge-success{background:rgba(34,197,94,.15);color:var(--success)}
.badge-danger{background:rgba(239,68,68,.15);color:var(--danger)}
.badge-warning{background:rgba(245,158,11,.15);color:var(--warning)}
.badge-info{background:rgba(59,130,246,.15);color:var(--info)}
.actions{display:flex;gap:8px}
.log-container{background:var(--bg-primary);border-radius:8px;padding:16px;font-family:'Monaco','Menlo',monospace;font-size:13px;max-height:500px;overflow-y:auto;line-height:1.6}
.log-line{padding:2px 0;white-space:pre-wrap;word-break:break-all}
.log-time{color:var(--text-muted);margin-right:8px}
.log-info{color:var(--info)}
.log-warning{color:var(--warning)}
.log-error{color:var(--danger)}
.log-success{color:var(--success)}
.empty-state{text-align:center;padding:48px;color:var(--text-secondary)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000}
.modal{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:32px;width:100%;max-width:480px}
.modal-title{font-size:20px;font-weight:600;margin-bottom:16px}
.modal-actions{display:flex;gap:12px;margin-top:24px;justify-content:flex-end}
.progress-bar{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;background:var(--accent);transition:width .3s}
.toast{position:fixed;bottom:24px;right:24px;padding:16px 24px;border-radius:8px;font-weight:500;z-index:1001;animation:slideIn .3s ease}
.toast-success{background:var(--success);color:white}
.toast-error{background:var(--danger);color:white}
@keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.tab-container{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid var(--border-color);padding-bottom:8px}
.tab-btn{padding:8px 16px;border-radius:6px;background:transparent;color:var(--text-secondary);border:none;cursor:pointer;font-size:14px;transition:all .2s}
.tab-btn:hover{color:var(--text-primary)}
.tab-btn.active{background:var(--accent);color:white}
.message-panel{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.contact-list{background:var(--bg-tertiary);border-radius:8px;max-height:400px;overflow-y:auto}
.contact-item{padding:12px 16px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background .2s}
.contact-item:hover{background:var(--bg-secondary)}
.contact-item.selected{background:var(--accent)}
.message-input-area{display:flex;flex-direction:column;gap:12px}
.message-input{min-height:100px;resize:vertical}
.auto-scroll-btn{position:absolute;bottom:12px;right:12px;padding:6px 12px;border-radius:6px;background:var(--accent);color:white;border:none;cursor:pointer;font-size:12px}
@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.message-panel{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app">
<div v-if="!isLoggedIn" class="login-container">
<div class="login-card">
<h1 class="login-title">Starrain-BOT</h1>
<p class="login-subtitle">QQæœºå™¨äººç®¡ç†åå°</p>
<form @submit.prevent="login">
<div class="form-group">
<label class="form-label">ç”¨æˆ·å</label>
<input type="text" class="form-input" v-model="loginForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off">
			</div>
			<div class="form-group">
				<label class="form-label">å¯†ç </label>
				<input type="password" class="form-input" v-model="loginForm.password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="off">
</div>
<button type="submit" class="btn btn-primary" :disabled="loginLoading">{{ loginLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}</button>
</form>
</div>
</div>

<div v-else class="app-container">
<aside class="sidebar">
<div class="sidebar-header">
<div class="sidebar-brand">Starrain-BOT</div>
<div class="sidebar-status">
<span class="status-dot" :class="{disconnected:!wsConnected}"></span>
<span>{{ wsConnected ? 'å®æ—¶è¿æ¥' : 'è¿æ¥æ–­å¼€' }}</span>
</div>
</div>
<nav class="sidebar-nav">
<div class="nav-item" :class="{active:currentPage==='dashboard'}" @click="currentPage='dashboard'"><span>ğŸ“Š</span> ä»ªè¡¨ç›˜</div>
<div class="nav-item" :class="{active:currentPage==='message'}" @click="currentPage='message';loadContacts()"><span>ğŸ’¬</span> æ¶ˆæ¯å‘é€</div>
<div class="nav-item" :class="{active:currentPage==='plugins'}" @click="currentPage='plugins'"><span>ğŸ”Œ</span> æ’ä»¶ç®¡ç†</div>
<div class="nav-item" :class="{active:currentPage==='permissions'}" @click="currentPage='permissions'"><span>ğŸ‘¥</span> æƒé™ç®¡ç†</div>
<div class="nav-item" :class="{active:currentPage==='blacklist'}" @click="currentPage='blacklist'"><span>ğŸš«</span> ç¾¤é»‘åå•</div>
<div class="nav-item" :class="{active:currentPage==='logs'}" @click="currentPage='logs'"><span>ğŸ“‹</span> å®æ—¶æ—¥å¿—</div>
<div class="nav-item" :class="{active:currentPage==='system'}" @click="currentPage='system'"><span>âš™ï¸</span> ç³»ç»Ÿæ“ä½œ</div>
<div class="nav-item" @click="logout" style="margin-top:auto;border-top:1px solid var(--border-color);padding-top:16px"><span>ğŸšª</span> é€€å‡ºç™»å½•</div>
</nav>
</aside>

<main class="main-content">
<div v-if="currentPage==='dashboard'">
<div class="page-header"><h1 class="page-title">ä»ªè¡¨ç›˜</h1><p class="page-desc">æœºå™¨äººè¿è¡ŒçŠ¶æ€æ¦‚è§ˆ</p></div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">æœºå™¨äººQQ</div><div class="stat-value">{{ status.qq || '-' }}</div></div>
<div class="stat-card"><div class="stat-label">è¿è¡Œæ—¶é—´</div><div class="stat-value success">{{ status.uptime_formatted || '-' }}</div></div>
<div class="stat-card"><div class="stat-label">å·²åŠ è½½æ’ä»¶</div><div class="stat-value">{{ status.plugins_count || 0 }} / {{ status.enabled_plugins_count || 0 }}</div></div>
<div class="stat-card"><div class="stat-label">è¿è¡ŒçŠ¶æ€</div><div class="stat-value" :class="status.running?'success':'danger'">{{ status.running?'è¿è¡Œä¸­':'å·²åœæ­¢' }}</div></div>
</div>
<div class="card">
<h3 class="card-title">ğŸ–¥ï¸ é€‚é…å™¨çŠ¶æ€</h3>
<div class="table-container">
<table>
<thead><tr><th>é€‚é…å™¨</th><th>çŠ¶æ€</th></tr></thead>
<tbody>
<tr v-for="a in status.adapters" :key="a.name">
<td>{{ a.name }}</td>
<td><span class="badge" :class="a.connected?'badge-success':'badge-danger'">{{ a.connected?'å·²è¿æ¥':'æœªè¿æ¥' }}</span></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="card" v-if="status.system">
<h3 class="card-title">ğŸ’» ç³»ç»Ÿä¿¡æ¯</h3>
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Pythonç‰ˆæœ¬</div><div class="stat-value">{{ status.system.python }}</div></div>
<div class="stat-card"><div class="stat-label">æ“ä½œç³»ç»Ÿ</div><div class="stat-value">{{ status.system.platform }}</div></div>
<div class="stat-card"><div class="stat-label">CPUä½¿ç”¨</div><div class="stat-value">{{ status.system.cpu_percent }}%</div></div>
<div class="stat-card">
<div class="stat-label">å†…å­˜ä½¿ç”¨</div>
<div class="stat-value">{{ status.system.memory.percent }}%</div>
<div class="progress-bar"><div class="progress-fill" :style="{width:status.system.memory.percent+'%'}"></div></div>
</div>
</div>
</div>
</div>

<div v-if="currentPage==='message'">
<div class="page-header"><h1 class="page-title">æ¶ˆæ¯å‘é€</h1><p class="page-desc">å‘å¥½å‹æˆ–ç¾¤å‘é€æ¶ˆæ¯</p></div>
<div class="card">
<div class="tab-container">
<button class="tab-btn" :class="{active:messageTab==='group'}" @click="messageTab='group'">ç¾¤èŠ</button>
<button class="tab-btn" :class="{active:messageTab==='private'}" @click="messageTab='private'">ç§èŠ</button>
</div>
<div class="message-panel">
<div class="card" style="margin:0">
<h3 class="card-title">{{ messageTab==='group'?'ç¾¤åˆ—è¡¨':'å¥½å‹åˆ—è¡¨' }}</h3>
<div class="contact-list">
<div v-if="contactLoading" class="empty-state">åŠ è½½ä¸­...</div>
<div v-else-if="messageTab==='group'">
<div class="contact-item" v-for="g in groups" :key="g.group_id" :class="{selected:selectedContact===g.group_id}" @click="selectedContact=g.group_id">
<div style="font-weight:600">{{ g.group_name || g.group_id }}</div>
<div style="font-size:12px;color:var(--text-secondary)">{{ g.group_id }} Â· {{ g.member_count || '?' }}äºº</div>
</div>
<div class="empty-state" v-if="groups.length===0">æš‚æ— ç¾¤</div>
</div>
<div v-else>
<div class="contact-item" v-for="f in friends" :key="f.user_id" :class="{selected:selectedContact===f.user_id}" @click="selectedContact=f.user_id">
<div style="font-weight:600">{{ f.nickname || f.user_id }}</div>
<div style="font-size:12px;color:var(--text-secondary)">{{ f.user_id }}</div>
</div>
<div class="empty-state" v-if="friends.length===0">æš‚æ— å¥½å‹</div>
</div>
</div>
</div>
<div class="message-input-area">
<div class="form-group">
<label class="form-label">{{ messageTab==='group'?'ç¾¤å·':'QQå·' }}</label>
<input type="text" class="form-input" v-model.number="selectedContact" :placeholder="messageTab==='group'?'è¾“å…¥ç¾¤å·':'è¾“å…¥QQå·'">
</div>
<div class="form-group">
<label class="form-label">æ¶ˆæ¯å†…å®¹</label>
<textarea class="form-input message-input" v-model="messageContent" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯..."></textarea>
</div>
<button class="btn btn-primary" @click="sendMessage" :disabled="sendingMessage">{{ sendingMessage?'å‘é€ä¸­...':'å‘é€æ¶ˆæ¯' }}</button>
</div>
</div>
</div>
</div>

<div v-if="currentPage==='plugins'">
<div class="page-header"><h1 class="page-title">æ’ä»¶ç®¡ç†</h1><p class="page-desc">ç®¡ç†æœºå™¨äººæ’ä»¶</p></div>
<div class="card">
<div class="table-container">
<table>
<thead><tr><th>æ’ä»¶åç§°</th><th>ç‰ˆæœ¬</th><th>ä½œè€…</th><th>æè¿°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
<tbody>
<tr v-for="p in plugins" :key="p.name">
<td><strong>{{ p.name }}</strong></td>
<td>v{{ p.version }}</td>
<td>{{ p.author }}</td>
<td>{{ p.description || '-' }}</td>
<td><span class="badge" :class="p.enabled?'badge-success':'badge-danger'">{{ p.enabled?'å·²å¯ç”¨':'å·²ç¦ç”¨' }}</span></td>
<td>
<div class="actions">
<button class="btn btn-secondary btn-sm" v-if="!p.enabled" @click="enablePlugin(p.name)">å¯ç”¨</button>
<button class="btn btn-secondary btn-sm" v-else @click="disablePlugin(p.name)">ç¦ç”¨</button>
<button class="btn btn-secondary btn-sm" @click="reloadPlugin(p.name)">é‡è½½</button>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="empty-state" v-if="plugins.length===0">æš‚æ— æ’ä»¶</div>
</div>
</div>

<div v-if="currentPage==='permissions'">
<div class="page-header"><h1 class="page-title">æƒé™ç®¡ç†</h1><p class="page-desc">ç®¡ç†æœºå™¨äººæƒé™ç”¨æˆ·</p></div>
<div class="card">
<h3 class="card-title">ğŸ”¶ 3çº§ç®¡ç†å‘˜</h3>
<div class="form-group" style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
<input type="text" class="form-input" v-model.trim="newAdmin.qq" placeholder="è¾“å…¥QQå·" style="flex:1;min-width:250px" @keyup.enter="addAdmin">
<button class="btn btn-primary btn-sm" @click="addAdmin">æ·»åŠ </button>
</div>
<div class="table-container">
<table><thead><tr><th>QQå·</th><th>æ“ä½œ</th></tr></thead>
<tbody><tr v-for="qq in permissions.admins" :key="qq"><td>{{ qq }}</td><td><button class="btn btn-danger btn-sm" @click="removeAdmin(qq)">ç§»é™¤</button></td></tr></tbody></table>
</div>
</div>
<div class="card">
<h3 class="card-title">ğŸŸ  4çº§æ‰€æœ‰è€…</h3>
<div class="form-group" style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
<input type="text" class="form-input" v-model.trim="newOwner.qq" placeholder="è¾“å…¥QQå·" style="flex:1;min-width:250px" @keyup.enter="addOwner">
<button class="btn btn-primary btn-sm" @click="addOwner">æ·»åŠ </button>
</div>
<div class="table-container">
<table><thead><tr><th>QQå·</th><th>æ“ä½œ</th></tr></thead>
<tbody><tr v-for="qq in permissions.owners" :key="qq"><td>{{ qq }}</td><td><button class="btn btn-danger btn-sm" @click="removeOwner(qq)">ç§»é™¤</button></td></tr></tbody></table>
</div>
</div>
<div class="card">
<h3 class="card-title">ğŸ”´ 5çº§å¼€å‘è€…</h3>
<div class="form-group" style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
<input type="text" class="form-input" v-model.trim="newDeveloper.qq" placeholder="è¾“å…¥QQå·" style="flex:1;min-width:250px" @keyup.enter="addDeveloper">
<button class="btn btn-primary btn-sm" @click="addDeveloper">æ·»åŠ </button>
</div>
<div class="table-container">
<table><thead><tr><th>QQå·</th><th>æ“ä½œ</th></tr></thead>
<tbody><tr v-for="qq in permissions.developers" :key="qq"><td>{{ qq }}</td><td><button class="btn btn-danger btn-sm" @click="removeDeveloper(qq)">ç§»é™¤</button></td></tr></tbody></table>
</div>
</div>
</div>

<div v-if="currentPage==='blacklist'">
<div class="page-header"><h1 class="page-title">ç¾¤é»‘åå•</h1><p class="page-desc">ç®¡ç†è¢«æ‹‰é»‘çš„ç¾¤</p></div>
<div class="card">
<div class="form-group" style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
<input type="text" class="form-input" v-model.trim="newBlacklist.group_id" placeholder="è¾“å…¥ç¾¤å·" style="flex:1;min-width:250px" @keyup.enter="addBlacklist">
<button class="btn btn-primary btn-sm" @click="addBlacklist">æ·»åŠ é»‘åå•</button>
</div>
<div class="table-container">
<table><thead><tr><th>ç¾¤å·</th><th>æ“ä½œ</th></tr></thead>
<tbody><tr v-for="g in blacklist.groups" :key="g"><td>{{ g }}</td><td><button class="btn btn-danger btn-sm" @click="removeBlacklist(g)">ç§»é™¤</button></td></tr></tbody></table>
</div>
<div class="empty-state" v-if="blacklist.groups.length===0">æš‚æ— é»‘åå•ç¾¤</div>
</div>
</div>

<div v-if="currentPage==='logs'">
<div class="page-header"><h1 class="page-title">å®æ—¶æ—¥å¿—</h1><p class="page-desc">æŸ¥çœ‹æœºå™¨äººè¿è¡Œæ—¥å¿— (WebSocketå®æ—¶æ¨é€)</p></div>
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<span class="stat-label">å®æ—¶æ—¥å¿— (å…±{{ logs.length }}æ¡)</span>
<div class="actions">
<button class="btn btn-secondary btn-sm" @click="autoScroll=!autoScroll">{{ autoScroll?'åœæ­¢æ»šåŠ¨':'è‡ªåŠ¨æ»šåŠ¨' }}</button>
<button class="btn btn-secondary btn-sm" @click="logs=[]">æ¸…ç©º</button>
<button class="btn btn-secondary btn-sm" @click="fetchLogs">åˆ·æ–°å†å²</button>
</div>
</div>
<div class="log-container" ref="logContainer" style="position:relative;max-height:600px">
<div class="log-line" v-for="(log,i) in logs" :key="i" :class="getLogClass(log)">{{ log }}</div>
<div class="empty-state" v-if="logs.length===0">æš‚æ— æ—¥å¿—</div>
</div>
</div>
</div>

<div v-if="currentPage==='system'">
<div class="page-header"><h1 class="page-title">ç³»ç»Ÿæ“ä½œ</h1><p class="page-desc">æœºå™¨äººç³»ç»Ÿæ§åˆ¶</p></div>
<div class="card">
<h3 class="card-title">âš ï¸ å±é™©æ“ä½œ</h3>
<p style="color:var(--text-secondary);margin-bottom:24px">ä»¥ä¸‹æ“ä½œä¼šå½±å“æœºå™¨äººè¿è¡ŒçŠ¶æ€ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
<div class="actions">
<button class="btn btn-warning" @click="showRestartModal=true">é‡å¯æœºå™¨äºº</button>
<button class="btn btn-danger" @click="showShutdownModal=true">å…³é—­æœºå™¨äºº</button>
</div>
</div>
</div>
</main>
</div>

<div class="modal-overlay" v-if="showRestartModal" @click.self="showRestartModal=false">
<div class="modal">
<h3 class="modal-title">ç¡®è®¤é‡å¯</h3>
<p style="color:var(--text-secondary)">ç¡®å®šè¦é‡å¯æœºå™¨äººå—ï¼Ÿé‡å¯æœŸé—´æœºå™¨äººå°†æ— æ³•å“åº”æ¶ˆæ¯ã€‚</p>
<div class="modal-actions">
<button class="btn btn-secondary" @click="showRestartModal=false">å–æ¶ˆ</button>
<button class="btn btn-warning" @click="restartBot">ç¡®è®¤é‡å¯</button>
</div>
</div>
</div>

<div class="modal-overlay" v-if="showShutdownModal" @click.self="showShutdownModal=false">
<div class="modal">
<h3 class="modal-title">ç¡®è®¤å…³é—­</h3>
<p style="color:var(--text-secondary)">ç¡®å®šè¦å…³é—­æœºå™¨äººå—ï¼Ÿå…³é—­åéœ€è¦æ‰‹åŠ¨é‡å¯ã€‚</p>
<div class="modal-actions">
<button class="btn btn-secondary" @click="showShutdownModal=false">å–æ¶ˆ</button>
<button class="btn btn-danger" @click="shutdownBot">ç¡®è®¤å…³é—­</button>
</div>
</div>
</div>

<div class="toast" :class="'toast-'+toast.type" v-if="toast.show">{{ toast.message }}</div>
</div>

<script>
const{createApp,ref,reactive,onMounted,onUnmounted,watch,nextTick}=Vue;
createApp({
setup(){
const isLoggedIn=ref(false);
	const loginForm=reactive({username:'',password:''});
	const loginLoading=ref(false);
	const token=ref(sessionStorage.getItem('token')||'');
const currentPage=ref('dashboard');
const wsConnected=ref(false);
let ws=null;
let refreshTimer=null;

const status=reactive({qq:0,uptime:0,uptime_formatted:'',running:false,adapters:[],plugins_count:0,enabled_plugins_count:0,system:null});
const plugins=ref([]);
const permissions=reactive({admins:[],owners:[],developers:[]});
const blacklist=reactive({groups:[]});
const logs=ref([]);
const autoScroll=ref(true);
const logContainer=ref(null);

const messageTab=ref('group');
const groups=ref([]);
const friends=ref([]);
const selectedContact=ref(null);
const messageContent=ref('');
const contactLoading=ref(false);
const sendingMessage=ref(false);

const newAdmin=reactive({qq:''});
const newOwner=reactive({qq:''});
const newDeveloper=reactive({qq:''});
const newBlacklist=reactive({group_id:''});

const showRestartModal=ref(false);
const showShutdownModal=ref(false);
const toast=reactive({show:false,message:'',type:'success'});

const showToast=(message,type='success')=>{
toast.message=message;
toast.type=type;
toast.show=true;
setTimeout(()=>{toast.show=false},3000);
};

const api=async(url,options={})=>{
const headers={'Content-Type':'application/json'};
if(token.value)headers['Authorization']=`Bearer ${token.value}`;
const res=await fetch(url,{...options,headers});
const data=await res.json().catch(()=>({}));
if(res.status===401){
		isLoggedIn.value=false;
		sessionStorage.removeItem('token');
		throw new Error(data.error||'æœªæˆæƒ');
	}
if(res.status===429){
throw new Error(data.error||'è¯·æ±‚è¿‡äºé¢‘ç¹');
}
if(!res.ok){
throw new Error(data.error||`è¯·æ±‚å¤±è´¥(${res.status})`);
}
return data;
};

const login=async()=>{
loginLoading.value=true;
try{
const res=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(loginForm)});
const data=await res.json().catch(()=>({}));
if(data.success){
		token.value=data.token;
		sessionStorage.setItem('token',data.token);
		isLoggedIn.value=true;
		loginForm.username='';
		loginForm.password='';
		showToast('ç™»å½•æˆåŠŸ');
fetchAll();
connectWS();
startRefreshTimer();
}else{
showToast(data.error||'ç™»å½•å¤±è´¥','error');
}
}catch(e){
showToast(e.message||'ç™»å½•å¤±è´¥','error');
}
loginLoading.value=false;
};

const logout=async()=>{
	try{
		await fetch('/api/logout',{method:'POST',headers:{'Authorization':`Bearer ${token.value}`}});
	}catch(e){}
	token.value='';
	sessionStorage.removeItem('token');
	isLoggedIn.value=false;
if(ws){ws.close();ws=null;}
if(refreshTimer){clearInterval(refreshTimer);refreshTimer=null;}
showToast('å·²é€€å‡ºç™»å½•');
};

const connectWS=()=>{
if(ws){ws.close();}
const protocol=location.protocol==='https:'?'wss:':'ws:';
ws=new WebSocket(`${protocol}//${location.host}/ws?token=${encodeURIComponent(token.value)}`);
ws.onopen=()=>{wsConnected.value=true;};
ws.onclose=(e)=>{
wsConnected.value=false;
if(e.code===4001){
showToast('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•','error');
logout();
return;
}
if(e.code===4003){
showToast('è¿æ¥æ•°è¿‡å¤š','error');
return;
}
setTimeout(()=>{if(isLoggedIn.value)connectWS();},3000);
};
ws.onerror=()=>{};
ws.onmessage=(e)=>{
try{
const data=JSON.parse(e.data);
if(data.type==='log'){
logs.value.push(data.message);
if(logs.value.length>500)logs.value.shift();
scrollToBottom();
}else if(data.type==='plugin_update'){
fetchPlugins();
}else if(data.type==='permission_update'){
fetchPermissions();
}else if(data.type==='blacklist_update'){
fetchBlacklist();
}
}catch(err){}
};
};

const scrollToBottom=()=>{
if(autoScroll.value&&logContainer.value){
nextTick(()=>{logContainer.value.scrollTop=logContainer.value.scrollHeight;});
}
};

const fetchStatus=async()=>{try{Object.assign(status,await api('/api/status'));}catch(e){}};
const fetchPlugins=async()=>{try{plugins.value=(await api('/api/plugins')).plugins;}catch(e){}};
const fetchPermissions=async()=>{try{Object.assign(permissions,await api('/api/permissions/admins'));}catch(e){}};
const fetchBlacklist=async()=>{try{Object.assign(blacklist,await api('/api/blacklist'));}catch(e){}};
const fetchLogs=async()=>{try{logs.value=(await api('/api/logs?lines=200')).logs;}catch(e){}};
const fetchAll=()=>{fetchStatus();fetchPlugins();fetchPermissions();fetchBlacklist();};

const loadContacts=async()=>{
if(messageTab.value==='group'&&groups.value.length===0){
contactLoading.value=true;
try{groups.value=(await api('/api/groups')).groups||[];}catch(e){}
contactLoading.value=false;
}else if(messageTab.value==='private'&&friends.value.length===0){
contactLoading.value=true;
try{friends.value=(await api('/api/friends')).friends||[];}catch(e){}
contactLoading.value=false;
}
};

watch(messageTab,()=>{selectedContact.value=null;loadContacts();});

const sendMessage=async()=>{
if(!selectedContact.value||!messageContent.value.trim()){
showToast('è¯·é€‰æ‹©è”ç³»äººå¹¶è¾“å…¥æ¶ˆæ¯','error');
return;
}
sendingMessage.value=true;
try{
await api('/api/message/send',{method:'POST',body:JSON.stringify({
message_type:messageTab.value,
user_id:messageTab.value==='private'?selectedContact.value:null,
group_id:messageTab.value==='group'?selectedContact.value:null,
message:messageContent.value
})});
showToast('æ¶ˆæ¯å‘é€æˆåŠŸ');
messageContent.value='';
}catch(e){showToast('æ¶ˆæ¯å‘é€å¤±è´¥','error');}
sendingMessage.value=false;
};

const enablePlugin=async(name)=>{await api('/api/plugins/enable',{method:'POST',body:JSON.stringify({plugin_name:name})});showToast('æ’ä»¶å·²å¯ç”¨');fetchPlugins();};
const disablePlugin=async(name)=>{await api('/api/plugins/disable',{method:'POST',body:JSON.stringify({plugin_name:name})});showToast('æ’ä»¶å·²ç¦ç”¨');fetchPlugins();};
const reloadPlugin=async(name)=>{await api('/api/plugins/reload',{method:'POST',body:JSON.stringify({plugin_name:name})});showToast('æ’ä»¶å·²é‡è½½');fetchPlugins();};

const addAdmin=async()=>{
const qq=parseInt(newAdmin.qq);
if(!qq||qq<=0){showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„QQå·','error');return;}
await api('/api/permissions/admins/add',{method:'POST',body:JSON.stringify({qq})});
showToast('ç®¡ç†å‘˜å·²æ·»åŠ ');newAdmin.qq='';fetchPermissions();
};
const removeAdmin=async(qq)=>{await api('/api/permissions/admins/remove',{method:'POST',body:JSON.stringify({qq})});showToast('ç®¡ç†å‘˜å·²ç§»é™¤');fetchPermissions();};
const addOwner=async()=>{
const qq=parseInt(newOwner.qq);
if(!qq||qq<=0){showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„QQå·','error');return;}
await api('/api/permissions/owners/add',{method:'POST',body:JSON.stringify({qq})});
showToast('æ‰€æœ‰è€…å·²æ·»åŠ ');newOwner.qq='';fetchPermissions();
};
const removeOwner=async(qq)=>{await api('/api/permissions/owners/remove',{method:'POST',body:JSON.stringify({qq})});showToast('æ‰€æœ‰è€…å·²ç§»é™¤');fetchPermissions();};
const addDeveloper=async()=>{
const qq=parseInt(newDeveloper.qq);
if(!qq||qq<=0){showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„QQå·','error');return;}
await api('/api/permissions/developers/add',{method:'POST',body:JSON.stringify({qq})});
showToast('å¼€å‘è€…å·²æ·»åŠ ');newDeveloper.qq='';fetchPermissions();
};
const removeDeveloper=async(qq)=>{await api('/api/permissions/developers/remove',{method:'POST',body:JSON.stringify({qq})});showToast('å¼€å‘è€…å·²ç§»é™¤');fetchPermissions();};

const addBlacklist=async()=>{
const group_id=parseInt(newBlacklist.group_id);
if(!group_id||group_id<=0){showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¾¤å·','error');return;}
await api('/api/blacklist/add',{method:'POST',body:JSON.stringify({group_id})});
showToast('å·²æ·»åŠ é»‘åå•');newBlacklist.group_id='';fetchBlacklist();
};
const removeBlacklist=async(group_id)=>{await api('/api/blacklist/remove',{method:'POST',body:JSON.stringify({group_id})});showToast('å·²ç§»é™¤é»‘åå•');fetchBlacklist();};

const restartBot=async()=>{await api('/api/system/restart',{method:'POST',body:JSON.stringify({confirm:true})});showRestartModal.value=false;showToast('æœºå™¨äººæ­£åœ¨é‡å¯...');};
const shutdownBot=async()=>{await api('/api/system/shutdown',{method:'POST',body:JSON.stringify({confirm:true})});showShutdownModal.value=false;showToast('æœºå™¨äººæ­£åœ¨å…³é—­...');};

const getLogClass=(log)=>{
if(log.includes('ERROR')||log.includes('error'))return'log-error';
if(log.includes('WARNING')||log.includes('warning'))return'log-warning';
if(log.includes('SUCCESS')||log.includes('success'))return'log-success';
if(log.includes('INFO')||log.includes('info'))return'log-info';
return'';
};

const startRefreshTimer=()=>{
if(refreshTimer)clearInterval(refreshTimer);
refreshTimer=setInterval(()=>{fetchStatus();},5000);
};

const checkAuth=async()=>{
	if(!token.value)return;
	try{
		await api('/api/status');
		isLoggedIn.value=true;
		fetchAll();
		connectWS();
		startRefreshTimer();
	}catch(e){
		token.value='';
		sessionStorage.removeItem('token');
	}
};

onMounted(()=>{
checkAuth();
});

onUnmounted(()=>{
if(ws)ws.close();
if(refreshTimer)clearInterval(refreshTimer);
});

return{
isLoggedIn,loginForm,loginLoading,currentPage,wsConnected,
status,plugins,permissions,blacklist,logs,autoScroll,logContainer,
messageTab,groups,friends,selectedContact,messageContent,contactLoading,sendingMessage,
newAdmin,newOwner,newDeveloper,newBlacklist,
showRestartModal,showShutdownModal,toast,
login,logout,fetchStatus,fetchPlugins,fetchPermissions,fetchBlacklist,fetchLogs,loadContacts,sendMessage,
enablePlugin,disablePlugin,reloadPlugin,
addAdmin,removeAdmin,addOwner,removeOwner,addDeveloper,removeDeveloper,
addBlacklist,removeBlacklist,restartBot,shutdownBot,getLogClass,showToast
};
}
}).mount('#app');
</script>
</body>
</html>
